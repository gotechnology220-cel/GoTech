<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bulk SMS ‚Äî GoTech CRM</title>
  <style>
    /* ====== RESET ====== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #222;
      min-height: 100vh;
    }

    a { text-decoration: none; color: white; }
    .small { font-size: 13px; }

    /* ====== HEADER ====== */
    header {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-bottom: 3px solid #0b63ce;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 999;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .header-left img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(11, 99, 206, 0.3);
      transition: transform 0.3s;
    }

    .header-left img:hover {
      transform: scale(1.1) rotate(5deg);
    }

    .header-center {
      text-align: center;
      flex: 1;
    }

    .header-center h1 {
      color: #d41f2d;
      font-size: 32px;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 8px;
    }

    .header-center p {
      font-size: 14px;
      color: #555;
      line-height: 1.6;
    }

    .header-right img {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      border: 3px solid #0b63ce;
      box-shadow: 0 4px 8px rgba(11, 99, 206, 0.3);
      transition: all 0.3s;
    }

    .header-right img:hover {
      transform: scale(1.1);
      border-color: #d41f2d;
    }

    /* ====== LANGUAGE TOGGLE ====== */
    .lang-toggle {
      position: absolute;
      top: 15px;
      right: 20px;
      display: flex;
      background: linear-gradient(90deg, #0b63ce, #2d66c3);
      border-radius: 25px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .lang-toggle button {
      border: none;
      background: none;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .lang-toggle button:hover {
      background: rgba(255,255,255,0.1);
    }
    .lang-toggle button.active {
      background: #003b82;
      font-weight: bold;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }

    /* ====== NAVIGATION ====== */
    nav {
      background: linear-gradient(90deg, #3f78e0, #2d66c3, #1e4f9f);
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 15px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    nav a {
      margin: 8px 25px;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      padding: 8px 16px;
      border-radius: 8px;
    }

    nav a:hover {
      color: #ffdf40;
      transform: translateY(-3px);
      background: rgba(255,255,255,0.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    nav a.active {
      background: rgba(255,255,255,0.2);
      color: #ffdf40;
    }

    /* ====== TOGGLE BUTTON (mobile) ====== */
    .toggle-btn {
      display: none;
      font-size: 28px;
      background: linear-gradient(135deg, #0b63ce, #2d66c3);
      border: none;
      cursor: pointer;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      nav {
        display: none;
        flex-direction: column;
        text-align: center;
      }
      nav.show { 
        display: flex; 
        animation: slideDown 0.3s ease-out;
      }
      .toggle-btn { display: block; position: absolute; top: 20px; left: 20px; }
      .header-center h1 { font-size: 24px; }
      .lang-toggle { top: 90px; }
      .composer-grid { grid-template-columns: 1fr; }
    }

    /* ====== MAIN SECTION ====== */
    .main-section {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .composer-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .composer-container h2 {
      color: #0b63ce;
      font-size: 32px;
      margin-bottom: 10px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .composer-container .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .composer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .filter-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filter-section h3 {
      color: #0b63ce;
      font-size: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .form-field label {
      font-weight: 600;
      color: #444;
      font-size: 14px;
    }

    .input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      font-family: inherit;
    }

    .input:focus {
      outline: none;
      border-color: #0b63ce;
      box-shadow: 0 0 0 3px rgba(11, 99, 206, 0.1);
    }

    .input:hover {
      border-color: #2d66c3;
    }

    textarea.input {
      resize: vertical;
      min-height: 150px;
    }

    .char-counter {
      text-align: right;
      font-size: 12px;
      color: #666;
      margin-top: -15px;
      margin-bottom: 10px;
    }

    .char-counter.warning {
      color: #ff9800;
      font-weight: 600;
    }

    .char-counter.danger {
      color: #d41f2d;
      font-weight: 700;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-group label {
      cursor: pointer;
      font-weight: 500;
    }

    /* ====== RECIPIENT SOURCE TABS ====== */
    .recipient-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .recipient-tabs button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .recipient-tabs button:hover {
      background: rgba(11, 99, 206, 0.05);
      color: #0b63ce;
    }

    .recipient-tabs button.active {
      color: #0b63ce;
      border-bottom-color: #0b63ce;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ====== FILE UPLOAD ====== */
    .upload-area {
      border: 2px dashed #0b63ce;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #2d66c3;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      transform: translateY(-2px);
    }

    .upload-area.dragover {
      border-color: #28a745;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #0b63ce;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .upload-subtext {
      color: #666;
      font-size: 13px;
    }

    .file-input {
      display: none;
    }

    /* ====== UPLOADED NUMBERS LIST ====== */
    .uploaded-numbers {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .uploaded-numbers .number-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .uploaded-numbers .number-item:last-child {
      margin-bottom: 0;
    }

    .number-item .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .number-item .remove-btn:hover {
      background: #c82333;
    }

    .clear-all-btn {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .clear-all-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .btn {
      padding: 14px 40px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0b63ce, #2d66c3);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(11, 99, 206, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .preview-section {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .preview-section h3 {
      color: #0b63ce;
      font-size: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .preview-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      min-height: 200px;
      border: 2px solid #0b63ce;
      box-shadow: 0 2px 8px rgba(11, 99, 206, 0.2);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .preview-placeholder {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 60px 20px;
    }

    .recipients-info {
      background: linear-gradient(135deg, #fff3cd, #ffe69c);
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 20px;
      border-left: 4px solid #ffc107;
    }

    .recipients-info .count {
      font-size: 24px;
      font-weight: 800;
      color: #0b63ce;
    }

    .message {
      padding: 14px 18px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      margin-top: 20px;
      animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .message.error {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }

    .message.loading {
      background: linear-gradient(135deg, #ffc107, #ffb300);
      color: #222;
    }

    .info-card {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }

    .info-card h4 {
      color: #1b5e20;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info-card ul {
      margin-left: 20px;
      color: #2e7d32;
      font-size: 14px;
      line-height: 1.8;
    }

    /* ====== FOOTER ====== */
    footer {
      background: linear-gradient(135deg, #1e4f9f, #0b63ce);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      padding: 25px 30px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
      margin-top: 60px;
    }

    footer .small { font-size: 12px; opacity: 0.9; }

    /* ====== SCROLL TO TOP ====== */
    .scroll-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #d41f2d, #ff4444);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(212, 31, 45, 0.5);
      transition: all 0.3s;
      z-index: 1000;
    }

    .scroll-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(212, 31, 45, 0.7);
    }

    .scroll-top.show {
      display: flex;
    }

  </style>
</head>
<body>

  <!-- ====== HEADER ====== -->
  <header>
    <button class="toggle-btn" id="menuToggle">‚ò∞</button>
    <div class="header-left">
      <img src="logo.png" alt="Company Logo">
    </div>
    <div class="header-center">
      <h1>Go Technology Solution Company</h1>
      <p>P.O.Box 22 - Ruvuma, Songea | Mob: 0655485784 / 0744065662<br>Email: gotechnology220@gmail.com</p>
      <div class="small"><i>We take the future to you</i></div>
    </div>
    <div class="header-right">
      <img src="dp.png" alt="Developer Photo">
    </div>
    <div class="lang-toggle">
      <button id="enBtn" class="active">English</button>
      <button id="swBtn">Swahili</button>
    </div>
  </header>

  <!-- ====== NAVIGATION ====== -->
  <nav id="navbar">
    <a href="index.html">üè† Home</a>
    <a href="register.html">üìù Register Customer</a>
    <a href="admin.html">üë§ Admin</a>
    <a href="composer.html" class="active">üí¨ Bulk SMS</a>
  </nav>

  <!-- ====== MAIN SECTION ====== -->
  <div class="main-section">
    <div class="composer-container">
      <h2>üí¨ Bulk SMS Composer</h2>
      <p class="subtitle">Send personalized SMS messages to your customers</p>

      <div class="info-card">
        <h4>‚ÑπÔ∏è How to use:</h4>
        <ul>
          <li>Choose recipient source: Database, Phone Contacts, or Excel File</li>
          <li>Compose your message (max 160 characters per SMS)</li>
          <li>Preview your message before sending</li>
          <li>Click "Send Messages" to dispatch SMS to selected recipients</li>
        </ul>
      </div>

      <div class="composer-grid">
        <!-- LEFT SECTION: FILTERS & MESSAGE -->
        <div class="filter-section">
          <h3>üìã Compose Message</h3>

          <!-- RECIPIENT SOURCE TABS -->
          <div class="recipient-tabs">
            <button class="tab-btn active" data-tab="database">üíæ Database</button>
            <button class="tab-btn" data-tab="contacts">üì± Contacts</button>
            <button class="tab-btn" data-tab="excel">üìä Excel</button>
          </div>

          <!-- DATABASE TAB -->
          <div id="database-tab" class="tab-content active">
            <div class="form-field">
              <label>Filter by Service</label>
              <select id="serviceFilter" class="input">
                <option value="">All Customers</option>
                <option value="CCTV">üìπ CCTV</option>
                <option value="Computer">üíª Computer</option>
                <option value="Printer">üñ®Ô∏è Printer</option>
                <option value="Router">üì° Router</option>
                <option value="Video Intercom">üîî Video Intercom</option>
                <option value="Time Attendance">‚è∞ Time Attendance</option>
              </select>
            </div>
          </div>

          <!-- CONTACTS TAB -->
          <div id="contacts-tab" class="tab-content">
            <div class="upload-area" id="contactsUpload">
              <div class="upload-icon">üì±</div>
              <div class="upload-text">Import from Phone Contacts</div>
              <div class="upload-subtext">Click to select contacts or use contact picker</div>
            </div>
            <input type="file" id="contactsFile" class="file-input" accept=".vcf,text/vcard">
            <button class="btn btn-primary" onclick="pickContacts()" style="margin-bottom: 15px;">
              üìû Pick from Contacts
            </button>
          </div>

          <!-- EXCEL TAB -->
          <div id="excel-tab" class="tab-content">
            <div class="upload-area" id="excelUpload">
              <div class="upload-icon">üìä</div>
              <div class="upload-text">Upload Excel File</div>
              <div class="upload-subtext">Drag & drop or click to browse (.xlsx, .xls, .csv)</div>
            </div>
            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls,.csv">
            <div class="small" style="color: #666; margin-bottom: 15px; text-align: center;">
              Excel should have columns: Name, Phone (or just Phone)
            </div>
          </div>

          <!-- UPLOADED NUMBERS DISPLAY -->
          <div id="uploadedNumbersContainer" style="display: none;">
            <button class="clear-all-btn" onclick="clearUploadedNumbers()">üóëÔ∏è Clear All Numbers</button>
            <div class="uploaded-numbers" id="uploadedNumbersList"></div>
          </div>

          <div class="form-field">
            <label>SMS Message</label>
            <textarea id="messageText" class="input" placeholder="Type your message here...&#10;&#10;Example:&#10;Hello! Special offer on CCTV systems this week. Contact us at 0744065662 for more details. - GoTech Solutions"></textarea>
            <div class="char-counter" id="charCounter">0 / 160 characters</div>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="includeNames" checked>
            <label for="includeNames">Personalize with customer names</label>
          </div>

          <button class="btn btn-primary" onclick="loadPreview()">üëÅÔ∏è Preview Message</button>
        </div>

        <!-- RIGHT SECTION: PREVIEW -->
        <div class="preview-section">
          <h3>üëÅÔ∏è Preview</h3>
          
          <div class="recipients-info">
            <div style="font-size: 14px; margin-bottom: 8px;">Selected Recipients:</div>
            <div class="count" id="recipientCount">0 customers</div>
          </div>

          <div style="margin-top: 20px; font-weight: 600; color: #0b63ce; margin-bottom: 10px;">
            Sample Message Preview:
          </div>
          <div class="preview-box" id="previewBox">
            <div class="preview-placeholder">
              Your message preview will appear here...
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-success" onclick="sendBulkSMS()">üì§ Send Messages</button>

      <div id="statusMsg"></div>
    </div>
  </div>

  <!-- ====== FOOTER ====== -->
  <footer>
    <div>
      <div style="font-weight:700; font-size: 16px;">Developed by: Go Technology Solution</div>
      <div class="small">üìû 0744065662 | ‚úâ yusuphlameck220@gmail.com</div>
    </div>
    <div class="small">¬© 2025 GoTech Solutions | All Rights Reserved</div>
  </footer>

  <!-- ====== SCROLL TO TOP ====== -->
  <div class="scroll-top" id="scrollTop">‚Üë</div>

  <!-- CDNJS Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhYKvxY6UdMBnxK8E6vvbZxDLmBNwPBnjXnA7bIWlEAUbbvDWedRdVqa0246fv7v7VRA/exec';

    let uploadedNumbers = [];
    let currentTab = 'database';

    // ====== TAB SWITCHING ======
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        currentTab = tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(tab + '-tab').classList.add('active');
        
        updateRecipientCount();
      });
    });

    // ====== MOBILE TOGGLE ======
    const toggleBtn = document.getElementById('menuToggle');
    const nav = document.getElementById('navbar');
    toggleBtn.addEventListener('click', () => {
      nav.classList.toggle('show');
    });

    // ====== LANGUAGE TOGGLE ======
    const enBtn = document.getElementById('enBtn');
    const swBtn = document.getElementById('swBtn');

    enBtn.addEventListener('click', () => {
      enBtn.classList.add('active');
      swBtn.classList.remove('active');
      showNotification("Language switched to English");
    });
    swBtn.addEventListener('click', () => {
      swBtn.classList.add('active');
      enBtn.classList.remove('active');
      showNotification("Lugha imebadilishwa kuwa Kiswahili");
    });

    // ====== NOTIFICATION SYSTEM ======
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: linear-gradient(135deg, #0b63ce, #2d66c3);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ====== SCROLL TO TOP ======
    const scrollTopBtn = document.getElementById('scrollTop');
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        scrollTopBtn.classList.add('show');
      } else {
        scrollTopBtn.classList.remove('show');
      }
    });
    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ====== CHARACTER COUNTER ======
    const messageText = document.getElementById('messageText');
    const charCounter = document.getElementById('charCounter');

    messageText.addEventListener('input', () => {
      const length = messageText.value.length;
      charCounter.textContent = `${length} / 160 characters`;
      
      if (length > 160) {
        charCounter.classList.add('danger');
        charCounter.classList.remove('warning');
      } else if (length > 140) {
        charCounter.classList.add('warning');
        charCounter.classList.remove('danger');
      } else {
        charCounter.classList.remove('warning', 'danger');
      }
    });

    // ====== FILE UPLOAD HANDLERS ======
    const contactsUpload = document.getElementById('contactsUpload');
    const contactsFile = document.getElementById('contactsFile');
    const excelUpload = document.getElementById('excelUpload');
    const excelFile = document.getElementById('excelFile');

    // Contacts upload
    contactsUpload.addEventListener('click', () => contactsFile.click());
    contactsFile.addEventListener('change', handleContactsUpload);

    // Excel upload
    excelUpload.addEventListener('click', () => excelFile.click());
    excelFile.addEventListener('change', handleExcelUpload);

    // Drag and drop for contacts
    contactsUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      contactsUpload.classList.add('dragover');
    });
    contactsUpload.addEventListener('dragleave', () => {
      contactsUpload.classList.remove('dragover');
    });
    contactsUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      contactsUpload.classList.remove('dragover');
      contactsFile.files = e.dataTransfer.files;
      handleContactsUpload();
    });

    // Drag and drop for excel
    excelUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelUpload.classList.add('dragover');
    });
    excelUpload.addEventListener('dragleave', () => {
      excelUpload.classList.remove('dragover');
    });
    excelUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      excelUpload.classList.remove('dragover');
      excelFile.files = e.dataTransfer.files;
      handleExcelUpload();
    });

    // ====== PICK CONTACTS (Contact Picker API) ======
    async function pickContacts() {
      if ('contacts' in navigator && 'ContactsManager' in window) {
        try {
          const props = ['name', 'tel'];
          const opts = { multiple: true };
          const contacts = await navigator.contacts.select(props, opts);
          
          contacts.forEach(contact => {
            if (contact.tel && contact.tel.length > 0) {
              contact.tel.forEach(phone => {
                const cleanPhone = cleanPhoneNumber(phone);
                if (cleanPhone) {
                  uploadedNumbers.push({
                    name: contact.name ? contact.name[0] : 'Unknown',
                    phone: cleanPhone
                  });
                }
              });
            }
          });
          
          displayUploadedNumbers();
          showNotification(`${contacts.length} contacts imported successfully!`);
        } catch (error) {
          showNotification('Contact picker not supported or cancelled');
        }
      } else {
        showNotification('Contact Picker API not supported on this browser');
      }
    }

    // ====== HANDLE CONTACTS FILE UPLOAD ======
    function handleContactsUpload() {
      const file = contactsFile.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        parseVCard(content);
      };
      reader.readAsText(file);
    }

    // ====== PARSE VCARD ======
    function parseVCard(vcardText) {
      const lines = vcardText.split('\n');
      let currentContact = {};
      let count = 0;

      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith('FN:')) {
          currentContact.name = line.substring(3);
        } else if (line.startsWith('TEL')) {
          const phone = line.split(':')[1];
          const cleanPhone = cleanPhoneNumber(phone);
          if (cleanPhone && currentContact.name) {
            uploadedNumbers.push({
              name: currentContact.name,
              phone: cleanPhone
            });
            count++;
          }
        } else if (line === 'END:VCARD') {
          currentContact = {};
        }
      });

      displayUploadedNumbers();
      showNotification(`${count} contacts imported from VCard!`);
    }

    // ====== HANDLE EXCEL FILE UPLOAD ======
    function handleExcelUpload() {
      const file = excelFile.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);

          let count = 0;
          jsonData.forEach(row => {
            const phone = cleanPhoneNumber(row.Phone || row.phone || row.PHONE);
            if (phone) {
              uploadedNumbers.push({
                name: row.Name || row.name || row.NAME || 'Customer',
                phone: phone
              });
              count++;
            }
          });

          displayUploadedNumbers();
          showNotification(`${count} contacts imported from Excel!`);
        } catch (error) {
          showNotification('Error reading Excel file');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ====== CLEAN PHONE NUMBER ======
    function cleanPhoneNumber(phone) {
      if (!phone) return null;
      
      // Remove all non-numeric characters
      let cleaned = phone.toString().replace(/\D/g, '');
      
      // Handle Tanzanian numbers
      if (cleaned.startsWith('255')) {
        return cleaned;
      } else if (cleaned.startsWith('0')) {
        return '255' + cleaned.substring(1);
      } else if (cleaned.length === 9) {
        return '255' + cleaned;
      }
      
      return cleaned.length >= 9 ? cleaned : null;
    }

    // ====== DISPLAY UPLOADED NUMBERS ======
    function displayUploadedNumbers() {
      const container = document.getElementById('uploadedNumbersContainer');
      const list = document.getElementById('uploadedNumbersList');
      
      if (uploadedNumbers.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      list.innerHTML = '';

      uploadedNumbers.forEach((contact, index) => {
        const item = document.createElement('div');
        item.className = 'number-item';
        item.innerHTML = `
          <span><strong>${contact.name}</strong> - ${contact.phone}</span>
          <button class="remove-btn" onclick="removeNumber(${index})">‚úï</button>
        `;
        list.appendChild(item);
      });

      updateRecipientCount();
    }

    // ====== REMOVE NUMBER ======
    function removeNumber(index) {
      uploadedNumbers.splice(index, 1);
      displayUploadedNumbers();
    }

    // ====== CLEAR UPLOADED NUMBERS ======
    function clearUploadedNumbers() {
      if (confirm('Are you sure you want to clear all uploaded numbers?')) {
        uploadedNumbers = [];
        displayUploadedNumbers();
        showNotification('All numbers cleared');
      }
    }

    // ====== UPDATE RECIPIENT COUNT ======
    function updateRecipientCount() {
      const countEl = document.getElementById('recipientCount');
      
      if (currentTab === 'database') {
        // For database, we'll estimate based on filter
        const filter = document.getElementById('serviceFilter').value;
        countEl.textContent = filter ? 'Filtered customers' : 'All customers';
      } else {
        countEl.textContent = `${uploadedNumbers.length} contacts`;
      }
    }

    // ====== LOAD PREVIEW ======
    function loadPreview() {
      const message = messageText.value.trim();
      const includeNames = document.getElementById('includeNames').checked;
      const previewBox = document.getElementById('previewBox');

      if (!message) {
        previewBox.innerHTML = '<div class="preview-placeholder">Please enter a message to preview</div>';
        return;
      }

      let sampleName = 'John Doe';
      if (currentTab !== 'database' && uploadedNumbers.length > 0) {
        sampleName = uploadedNumbers[0].name;
      }

      let finalMessage = message;
      if (includeNames) {
        finalMessage = `Hi ${sampleName},\n\n${message}`;
      }

      previewBox.textContent = finalMessage;
      showNotification('Preview updated!');
    }

    // ====== SEND BULK SMS ======
    async function sendBulkSMS() {
      const message = messageText.value.trim();
      const includeNames = document.getElementById('includeNames').checked;
      const statusMsg = document.getElementById('statusMsg');

      if (!message) {
        statusMsg.innerHTML = '<div class="message error">‚ùå Please enter a message</div>';
        return;
      }

      if (message.length > 160) {
        if (!confirm('Your message exceeds 160 characters and will be sent as multiple SMS. Continue?')) {
          return;
        }
      }

      // Get recipients based on current tab
      let recipients = [];
      
      if (currentTab === 'database') {
        statusMsg.innerHTML = '<div class="message loading">‚è≥ Fetching customers from database...</div>';
        
        try {
          const filter = document.getElementById('serviceFilter').value;
          const response = await fetch(`${SCRIPT_URL}?action=getCustomers&service=${filter}`);
          const data = await response.json();
          
          if (data.success) {
            recipients = data.customers.map(c => ({
              name: c.customerName,
              phone: cleanPhoneNumber(c.phone)
            })).filter(c => c.phone);
          }
        } catch (error) {
          statusMsg.innerHTML = '<div class="message error">‚ùå Error fetching customers from database</div>';
          return;
        }
      } else {
        recipients = uploadedNumbers;
      }

      if (recipients.length === 0) {
        statusMsg.innerHTML = '<div class="message error">‚ùå No recipients found</div>';
        return;
      }

      // Confirm before sending
      if (!confirm(`Send SMS to ${recipients.length} recipients?`)) {
        return;
      }

      statusMsg.innerHTML = `<div class="message loading">‚è≥ Sending SMS to ${recipients.length} recipients...</div>`;

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'sendBulkSMS',
            recipients: recipients,
            message: message,
            includeNames: includeNames
          })
        });

        statusMsg.innerHTML = `<div class="message success">‚úÖ SMS sent successfully to ${recipients.length} recipients!</div>`;
        
        // Clear form
        messageText.value = '';
        charCounter.textContent = '0 / 160 characters';
        document.getElementById('previewBox').innerHTML = '<div class="preview-placeholder">Your message preview will appear here...</div>';
        
        showNotification('Bulk SMS sent successfully!');
      } catch (error) {
        statusMsg.innerHTML = '<div class="message error">‚ùå Error sending SMS. Please try again.</div>';
      }
    }

    // ====== INITIALIZE ======
    document.getElementById('serviceFilter').addEventListener('change', updateRecipientCount);
    updateRecipientCount();
  </script>
</body>
</html>